name: Build Community .srs Files

on:
  push:
    tags:
      - '*'  # Триггер на любой новый тег

jobs:
  generate-community-srs:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Prepare Sing-Box refilter directories
      run: |
        mkdir -p $GITHUB_WORKSPACE/src/sing-box-files/refilter/community
        mkdir -p $GITHUB_WORKSPACE/src/sing-box-files/refilter/community_ip

        # Копируем community файлы в соответствующие папки
        cp community.lst $GITHUB_WORKSPACE/src/sing-box-files/refilter/community/
        cp community_ips.lst $GITHUB_WORKSPACE/src/sing-box-files/refilter/community_ip/

    - name: Generate .srs Files
      run: |
        cd $GITHUB_WORKSPACE/src/sing-box-files
        chmod +x generate-geoip-geosite

        # Генерация community.srs и community_ip.srs
        ./generate-geoip-geosite -i ./refilter/community -o ./refilter/community.srs
        ./generate-geoip-geosite -i ./refilter/community_ip -o ./refilter/community_ip.srs

    - name: Verify Output
      run: |
        echo "Содержимое refilter после генерации .srs:"
        ls -la $GITHUB_WORKSPACE/src/sing-box-files/refilter

    - name: Upload .srs Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: community-srs-files
        path: $GITHUB_WORKSPACE/src/sing-box-files/refilter/

    - name: Create Release
      uses: ncipollo/release-action@v1
      with:
        tag: ${{ github.ref_name }}
        name: "Release ${{ github.ref_name }}"
        body: "Automatic community.srs release for tag ${{ github.ref_name }}"
        files: |
          $GITHUB_WORKSPACE/src/sing-box-files/refilter/community.srs
          $GITHUB_WORKSPACE/src/sing-box-files/refilter/community_ip.srs
